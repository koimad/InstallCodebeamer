---

- name: Add the user 'codebeamer'
  ansible.builtin.user:
    name: codebeamer
    comment: codebeamer application account
    state: present

- name: Ensure Codebeamer Root Dirtectory Exists
  file:
    path: '{{ __codebeamer_root_dir }}'
    state: directory
    owner: codebeamer
    group: codebeamer
    mode: 0700

- name: Copy CodeBeamer File to Codebeamer user folder  
  copy:
    src: 'files/{{ __codebeamer_installer }}'
    dest: '/home/codebeamer'
    owner: codebeamer
    group: codebeamer
    mode: 0550

- name: Check if installation exists
  become: yes
  become_user: codebeamer
  stat:
    path: '{{ __codebeamer_install_dir }}'
  register: codebeamer_install_status

- name: Extract Contents of binary file
  become: yes
  become_user: codebeamer
  ansible.builtin.expect:
    command: sh /home/codebeamer/{{ __codebeamer_installer }} --quiet --accept
    responses:
      '.*Directory.*:': '{{ __codebeamer_install_dir }}'
      '.*Do you want to read the CUSTOMER AGREEMENT.*': 'n'
      '.*Do you agree with the CUSTOMER AGREEMENT.*': 'y'
      '.*Please enter the TCP/IP portnumber for codebeamer.*': '{{ __codebeamer_http_port }}'
      '.*Please enter the SSL TCP/IP portnumber for codebeamer.*': '{{ __codebeamer_https_port }}'
      '.*Please enter the SHUTDOWN portnumber for codebeamer.*': '{{ __codebeamer_shutdown_port }}'
      '.*Do you want to download MySQL JDBC driver and accept its license.*': 'n'
      '.*Do you want to upgrade from your existing codebeamer installation.*': 'n'
      '.*Do you want to start codebeamer setup wizard now.*': 'n'
  when: not codebeamer_install_status.stat.exists

- name: Create a codebeamer symbolic link
  become: yes
  become_user: codebeamer
  ansible.builtin.file:
    src: '{{ __codebeamer_install_dir }}'
    dest: '{{ __codebeamer_sym_link  }}'    
    state: link

- name: Copy CodeBeamer File to Codebeamer user folder
  copy:
    src: 'files/{{ __my_sql_connector_name }}'
    dest: "{{ ( __codebeamer_install_dir ,'tomcat/webapps/cb/WEB-INF/lib', __my_sql_connector_name) | path_join }}"
    owner: codebeamer
    group: root
    mode: 0550

- name: Copy codebeamer.service to /etc/systemd/system/
  template:
    src: "codebeamer.service.cnf.j2"
    dest: "/etc/systemd/system/codebeamer.service"
    owner: root
    group: root
    mode: 0444

- name: Copy SELinux policy files
  copy: 
    src: files/selinux/
    dest: selinux-modules/      

- name: find SELinux modules
  find:
    paths: selinux-modules
    file_type: file
    recurse: No
    patterns: "*.pp"
  register: modules_matched

- name: SELinux import modules
  command:
    cmd : semodule -X 300 -i {{ item.path }}  
  loop: '{{ modules_matched.files }}'
  loop_control:
    label: '{{ item.path }}'

- name: Enable Codebeamer service
  ansible.builtin.service:
    name: codebeamer
    state: started
    enabled: true

