---

- name: Add the user 'codebeamer'
  ansible.builtin.user:
    name: codebeamer
    comment: codebeamer application account
    state: present

- name: Ensure Codebeamer Root Dirtectory Exists
  file:
    path: '{{ __codebeamer_root_dir }}'
    state: directory
    owner: codebeamer
    group: codebeamer
    mode: 0700

- name: Copy CodeBeamer File to Codebeamer user folder  
  copy:
    src: 'files/{{ __codebeamer_installer }}'
    dest: '/home/codebeamer'
    owner: codebeamer
    group: codebeamer
    mode: 0550

- name: Check if installation exists
  become: yes
  become_user: codebeamer
  stat:
    path: '{{ __codebeamer_install_dir }}'
  register: codebeamer_install_status

- name: Extract Contents of binary file
  become: yes
  become_user: codebeamer
  ansible.builtin.expect:
    command: sh /home/codebeamer/{{ __codebeamer_installer }} --quiet --accept
    responses:
      '.*Directory.*:': '{{ __codebeamer_install_dir }}'
      '.*Do you want to read the CUSTOMER AGREEMENT.*': 'n'
      '.*Do you agree with the CUSTOMER AGREEMENT.*': 'y'
      '.*Please enter the TCP/IP portnumber for codebeamer.*': '{{ __codebeamer_http_port }}'
      '.*Please enter the SSL TCP/IP portnumber for codebeamer.*': '{{ __codebeamer_https_port }}'
      '.*Please enter the SHUTDOWN portnumber for codebeamer.*': '{{ __codebeamer_shutdown_port }}'
      '.*Do you want to download MySQL JDBC driver and accept its license.*': 'n'
      '.*Do you want to upgrade from your existing codebeamer installation.*': 'n'
      '.*Do you want to start codebeamer setup wizard now.*': 'n'
  when: not codebeamer_install_status.stat.exists

- name: Create a codebeamer symbolic link
  become: yes
  become_user: codebeamer
  ansible.builtin.file:
    src: '{{ __codebeamer_install_dir }}'
    dest: '{{ __codebeamer_sym_link  }}'    
    state: link

- name: Set SEContext of codebeamer directory
  sefcontext:
    target: '{{ __codebeamer_root_dir }}(/.*)?'
    setype: bin_t
    state: present
    
- name: Run restore context to reload selinux  
  command: 
    cmd: 'restorecon -RFvv {{ __codebeamer_root_dir }}'

- name: Copy CodeBeamer File to Codebeamer user folder
  copy:
    src: 'files/{{ __my_sql_connector_name }}'
    dest: "{{ ( __codebeamer_install_dir ,'tomcat/webapps/cb/WEB-INF/lib', __my_sql_connector_name) | path_join }}"
    owner: codebeamer
    group: root
    mode: 0550

# - name: Generate keystore
#   java_keystore:
#     name: codebeamer
#     certificate: "{{ lookup('file','files/certificate/codebeamer.public.key')}}"
#     private_key: "{{ lookup('file','files/certificate/codebeamer.private.key')}}"
#     password: cb_secret
#     dest: "{{  (__codebeamer_install_dir ,'keystore' ) | path_join }}"

- name: Copy codebeamer.service to /etc/systemd/system/
  template:
    src: "codebeamer.service.cnf.j2"
    dest: "/etc/systemd/system/codebeamer.service"
    owner: root
    group: root
    mode: 0444

- name: Update  CACERT_KEYSTORE_PATH in cb startup file to fix issue
  ansible.builtin.replace:
    path:  "{{ ( __codebeamer_sym_link ,'bin/cb', ) | path_join }}"
    after: "CACERT_KEYSTORE_PATH="
    regexp: '/home/appuser/codebeamer/cacerts'
    replace: "{{ ( __codebeamer_sym_link ,'cacerts', ) | path_join }}" 

- name: Enable Codebeamer service
  ansible.builtin.service:
    name: codebeamer
    state: started
    enabled: true

